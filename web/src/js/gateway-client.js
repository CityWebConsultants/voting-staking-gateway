var Web3,__awaiter=this&&this.__awaiter||function(i,o,s,c){return new(s||(s=Promise))(function(t,e){function n(t){try{a(c.next(t))}catch(t){e(t)}}function r(t){try{a(c.throw(t))}catch(t){e(t)}}function a(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,r)}a((c=c.apply(i,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,o,t,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(o=2&e[0]?i.return:e[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,e[1])).done)return o;switch(i=0,o&&(e=[2&e[0],o.value]),e[0]){case 0:case 1:o=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!o||e[1]>o[0]&&e[1]<o[3])){s.label=e[1];break}if(6===e[0]&&s.label<o[1]){s.label=o[1],o=e;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(e);break}o[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],i=0}finally{a=o=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};!function(t){var e=function(t,e,n,r,a){this.network=t,this.contractAddress=e,this.contractAbiUrl=n,this.tokenAddress=r,this.tokenContractAbiUrl=a};t.GatewayConfigObject=e,t.EventType={PaymentMadeEvent:"PaymentMadeEvent",WithdrawGatewayFundsEvent:"WithdrawGatewayFundsEvent",WithdrawPaymentEvent:"WithdrawPaymentEvent"},t.paymentStatus=function(t){return null==t||null==t?{}:{merchant:t.args._merchant,reference:t.args._reference,amountInWei:t.args._amount.c[0]}},t.withdrawalRecord=function(t){return null==t||null==t?{}:{merchant:t.args._walletAddress,amountInWei:t.args._amount.c[0]}}}(EthPaymentGateway||(EthPaymentGateway={}));var EthPaymentGateway,priceDiscoveryUrl="https://min-api.cryptocompare.com/data/price?fsym=ETH&tsyms=GBP";!function(o){var t=function(){function t(t){this.web3Instance=new Web3(web3.currentProvider),this.gatewayConfig=t}return t.prototype.getCostInWeiFromCostInGbp=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,fetch(priceDiscoveryUrl)];case 1:return[4,t.sent().json()];case 2:return e=t.sent(),[2,this.calculateCost(n,e.GBP)]}})})},t.prototype.getPaymentStatusFromMerchantAndReference=function(a,i){return __awaiter(this,void 0,void 0,function(){var e,n,r;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getEventsFromBlocks(o.EventType.PaymentMadeEvent,0,"latest")];case 1:for(e=t.sent(),n=0;n<e.length;n++)if((r=e[n]).args._merchant.toLowerCase()==a.toLowerCase()&&r.args._reference==i)return[2,o.paymentStatus(r)];return[2,o.paymentStatus(null)]}})})},t.prototype.getTransactionReceiptFromNetwork=function(n){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){return[2,this.promisify(function(t){return e.web3Instance.eth.getTransactionReceipt(n,t)})]})})},t.prototype.getPaymentReceivedStatusFromHash=function(i){return __awaiter(this,void 0,void 0,function(){var e,n,r,a;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getTransactionReceiptFromNetwork(i)];case 1:return(e=t.sent())?(n=e.blockNumber,[4,this.getEventsFromBlocks(o.EventType.PaymentMadeEvent,n,n)]):[2,o.paymentStatus(null)];case 2:return r=t.sent(),a=this.getEventFromListUsingTxHash(r,i),[2,o.paymentStatus(a)]}})})},t.prototype.getEventsFromBlocks=function(r,a,i){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getGatewayContract()];case 1:return e=t.sent(),n=null,r==o.EventType.PaymentMadeEvent&&(n=this.promisify(function(t){return e.PaymentMadeEvent({},{fromBlock:a,toBlock:i}).get(t)})),r==o.EventType.WithdrawPaymentEvent&&(n=this.promisify(function(t){return e.WithdrawPaymentEvent({},{fromBlock:a,toBlock:i}).get(t)})),r==o.EventType.WithdrawGatewayFundsEvent&&(n=this.promisify(function(t){return e.WithdrawGatewayFundsEvent({},{fromBlock:a,toBlock:i}).get(t)})),n?[4,n]:[2,null];case 2:return[2,t.sent()]}})})},t.prototype.getTokenBalance=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getTokenContract()];case 1:return e=t.sent(),[2,this.promisify(function(t){return e.balanceOf(n,t)})]}})})},t.prototype.withdrawMerchantBalance=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getGatewayContract()];case 1:return e=t.sent(),[2,this.promisify(function(t){return e.withdrawPayment(n,t)})]}})})},t.prototype.getGatewayContract=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContract(this.gatewayConfig.contractAddress,this.gatewayConfig.contractAbiUrl)];case 1:return[2,t.sent()]}})})},t.prototype.getTokenContract=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContract(this.gatewayConfig.tokenAddress,this.gatewayConfig.tokenContractAbiUrl)];case 1:return[2,t.sent()]}})})},t.prototype.getContract=function(n,r){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContractAbi(r)];case 1:return e=t.sent(),[4,this.web3Instance.eth.contract(e).at(n)];case 2:return[2,t.sent()]}})})},t.prototype.getContractAbi=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,fetch(e)];case 1:return[4,t.sent().json()];case 2:return[2,t.sent().abi]}})})},t.prototype.calculateCost=function(t,e){return t/e},t.prototype.getEventFromListUsingTxHash=function(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(r.transactionHash==e)return r}return null},t.prototype.createWithdrawalEventArray=function(t){for(var e=[],n=0;n<t.length;n++){var r=t[n];e.push(o.withdrawalRecord(r))}return e},t.prototype.promisify=function(t){return new Promise(function(n,r){return t(function(t,e){t?r(t):n(e)})})},t}();o.EthPaymentGatewayBase=t}(EthPaymentGateway||(EthPaymentGateway={})),function(e){var n=new e.GatewayConfigObject("https://rinkeby.infura.io/v3/e418fc96660e461ba2979615bc2269ad","0x6fcbf9822bcca91212ba58441ccae72aaadc9c7c","/abis/gateway-contract-abi.json","0x772f4e6eb507d5365e08c572b0e300f3dc074c1b","/abis/erc20-contract-abi.json"),t=function(){function t(t){var r=this;this.getPaymentStatusFromMerchantAndReference=function(e,n){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getPaymentStatusFromMerchantAndReference(e,n)];case 1:return[2,t.sent()]}})})},this.getTokenBalance=function(e){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getTokenBalance(e)];case 1:return[2,t.sent()]}})})},this.baseClass=new e.EthPaymentGatewayBase(n),this.merchant=t}return t.prototype.checkTransaction=function(n){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){return[2,this.baseClass.promisify(function(t){return e.baseClass.web3Instance.eth.getTransaction(n,t)})]})})},t.prototype.makePayment=function(a,i,o){return __awaiter(this,void 0,void 0,function(){var e,n,r=this;return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getGatewayContract()];case 1:return e=t.sent(),n=this.baseClass.promisify(function(t){return r.baseClass.web3Instance.toWei(i,"ether",t)}),[2,this.baseClass.promisify(function(t){return e.makePayment(a,o,{value:n},t)})]}})})},t.prototype.makePaymentUsingTokens=function(r,a,i){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getGatewayContract()];case 1:return e=t.sent(),console.log("merchant: "+r,"ref: "+a,"amount: "+i),n=this.baseClass.promisify(function(t){return e.makePaymentInTokens(r,a,i,t)}),console.log("payed with token",n),[2,n]}})})},t}();e.EthPaymentGatewayClient=t}(EthPaymentGateway||(EthPaymentGateway={}));