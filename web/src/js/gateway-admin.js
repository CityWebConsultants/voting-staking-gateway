var Web3,Promise,__awaiter=this&&this.__awaiter||function(i,s,o,c){return new(o||(o=Promise))(function(t,e){function n(t){try{a(c.next(t))}catch(t){e(t)}}function r(t){try{a(c.throw(t))}catch(t){e(t)}}function a(e){e.done?t(e.value):new o(function(t){t(e.value)}).then(n,r)}a((c=c.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,s,t,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,i=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){o.label=e[1];break}if(6===e[0]&&o.label<s[1]){o.label=s[1],s=e;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(e);break}s[2]&&o.ops.pop(),o.trys.pop();continue}e=r.call(n,o)}catch(t){e=[6,t],i=0}finally{a=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};!function(t){var e=function(t,e,n,r,a){this.network=t,this.contractAddress=e,this.contractAbiUrl=n,this.tokenAddress=r,this.tokenContractAbiUrl=a};t.GatewayConfigObject=e,t.EventType={PaymentMadeEvent:"PaymentMadeEvent",WithdrawGatewayFundsEvent:"WithdrawGatewayFundsEvent",WithdrawPaymentEvent:"WithdrawPaymentEvent"},t.paymentStatus=function(t){return null==t||null==t?{}:{merchant:t.args._merchant,reference:t.args._reference,amountInWei:t.args._amount.c[0]}},t.withdrawalRecord=function(t){return null==t||null==t?{}:{merchant:t.args._walletAddress,amountInWei:t.args._amount.c[0]}}}(EthPaymentGateway||(EthPaymentGateway={}));var EthPaymentGateway,priceDiscoveryUrl="https://min-api.cryptocompare.com/data/price?fsym=ETH&tsyms=GBP";!function(s){var t=function(){function t(t){this.web3Instance=new Web3(new Web3.providers.HttpProvider(t.network)),this.gatewayConfig=t}return t.prototype.getCostInWeiFromCostInGbp=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,fetch(priceDiscoveryUrl)];case 1:return[4,t.sent().json()];case 2:return e=t.sent(),[2,this.calculateCost(n,e.GBP)]}})})},t.prototype.getPaymentStatusFromMerchantAndReference=function(a,i){return __awaiter(this,void 0,void 0,function(){var e,n,r;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getEventsFromBlocks(s.EventType.PaymentMadeEvent,0,"latest")];case 1:for(e=t.sent(),n=0;n<e.length;n++)if((r=e[n]).args._merchant.toLowerCase()==a.toLowerCase()&&r.args._reference==i)return[2,s.paymentStatus(r)];return[2,s.paymentStatus(null)]}})})},t.prototype.getTransactionReceiptFromNetwork=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.web3Instance.eth.getTransactionReceipt(e)];case 1:return[2,t.sent()]}})})},t.prototype.getPaymentReceivedStatusFromHash=function(i){return __awaiter(this,void 0,void 0,function(){var e,n,r,a;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getTransactionReceiptFromNetwork(i)];case 1:return(e=t.sent())?(n=e.blockNumber,[4,this.getEventsFromBlocks(s.EventType.PaymentMadeEvent,n,n)]):[2,s.paymentStatus(null)];case 2:return r=t.sent(),a=this.getEventFromListUsingTxHash(r,i),[2,s.paymentStatus(a)]}})})},t.prototype.getEventsFromBlocks=function(r,a,i){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getGatewayContract()];case 1:return e=t.sent(),n=null,r==s.EventType.PaymentMadeEvent&&(n=this.promisify(function(t){return e.PaymentMadeEvent({},{fromBlock:a,toBlock:i}).get(t)})),r==s.EventType.WithdrawPaymentEvent&&(n=this.promisify(function(t){return e.WithdrawPaymentEvent({},{fromBlock:a,toBlock:i}).get(t)})),r==s.EventType.WithdrawGatewayFundsEvent&&(n=this.promisify(function(t){return e.WithdrawGatewayFundsEvent({},{fromBlock:a,toBlock:i}).get(t)})),n?[4,n]:[2,null];case 2:return[2,t.sent()]}})})},t.prototype.getTokenBalance=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getTokenContract()];case 1:return[4,t.sent().balanceOf(e)];case 2:return[2,t.sent()]}})})},t.prototype.withdrawMerchantBalance=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getGatewayContract()];case 1:return[4,t.sent().withdrawPayment(e)];case 2:return[2,t.sent()]}})})},t.prototype.getGatewayContract=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContract(this.gatewayConfig.contractAddress,this.gatewayConfig.contractAbiUrl)];case 1:return[2,t.sent()]}})})},t.prototype.getTokenContract=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContract(this.gatewayConfig.tokenAddress,this.gatewayConfig.tokenContractAbiUrl)];case 1:return[2,t.sent()]}})})},t.prototype.getContract=function(n,r){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.getContractAbi(r)];case 1:return e=t.sent(),[4,this.web3Instance.eth.contract(e).at(n)];case 2:return[2,t.sent()]}})})},t.prototype.getContractAbi=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,fetch(e)];case 1:return[4,t.sent().json()];case 2:return[2,t.sent().abi]}})})},t.prototype.calculateCost=function(t,e){return t/e},t.prototype.getEventFromListUsingTxHash=function(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(r.transactionHash==e)return r}return null},t.prototype.createWithdrawalEventArray=function(t){for(var e=[],n=0;n<t.length;n++){var r=t[n];e.push(s.withdrawalRecord(r))}return e},t.prototype.promisify=function(t){return new Promise(function(n,r){return t(function(t,e){t?r(t):n(e)})})},t}();s.EthPaymentGatewayBase=t}(EthPaymentGateway||(EthPaymentGateway={})),function(n){var e=new n.GatewayConfigObject("http://localhost:7545","0x21b072d12ae68fc4ca02e3fea7a12bf5e001e79f","http://127.0.0.1/abis/gateway-contract-abi.json","0xe186255319a4c5354e57ae553811498a5129e790","http://127.0.0.1/abis/erc20-contract-abi.json"),t=function(){function t(){var t=this;this.withdrawMerchantBalance=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.withdrawMerchantBalance(e)];case 1:return[2,t.sent()]}})})},this.getCostInWeiFromCostInGbp=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getCostInWeiFromCostInGbp(e)];case 1:return[2,t.sent()]}})})},this.getTransactionReceiptFromNetwork=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){return[2,this.baseClass.getTransactionReceiptFromNetwork(e)]})})},this.getPaymentStatusFromMerchantAndReference=function(e,n){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getPaymentStatusFromMerchantAndReference(e,n)];case 1:return[2,t.sent()]}})})},this.getTokenBalance=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getTokenBalance(e)];case 1:return[2,t.sent()]}})})},this.baseClass=new n.EthPaymentGatewayBase(e)}return t.prototype.addMerchant=function(e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getGatewayContract()];case 1:return[4,t.sent().addMerchant(e,n)];case 2:return[2,t.sent()]}})})},t.prototype.issueTokens=function(e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getTokenContract()];case 1:return[4,t.sent().issueTokens(e,n)];case 2:return[2,t.sent()]}})})},t.prototype.withdrawGatewayFees=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getGatewayContract()];case 1:return[4,t.sent().withdrawGatewayFees()];case 2:return[2,t.sent()]}})})},t.prototype.setTokenContractAddress=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getGatewayContract()];case 1:return[4,t.sent().setTokenContract(e)];case 2:return[2,t.sent()]}})})},t.prototype.setPaymentContractAddress=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getTokenContract()];case 1:return[4,t.sent().setPaymentGatewayAddress(e)];case 2:return[2,t.sent()]}})})},t.prototype.getGatewayWithdrawalHistory=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getEventsFromBlocks(n.EventType.WithdrawGatewayFundsEvent,0,"latest")];case 1:return e=t.sent(),[2,this.baseClass.createWithdrawalEventArray(e)]}})})},t.prototype.getMerchantWithdrawalHistory=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getEventsFromBlocks(n.EventType.WithdrawPaymentEvent,0,"latest")];case 1:return e=t.sent(),[2,this.baseClass.createWithdrawalEventArray(e)]}})})},t.prototype.getTokenIssueEvents=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.baseClass.getTokenContract()];case 1:return e=t.sent(),[4,this.baseClass.promisify(function(t){return e.IssueTokens({},{fromBlock:0,toBlock:"latest"}).get(t)})];case 2:return[2,t.sent()]}})})},t}();n.EthPaymentGatewayAdmin=t}(EthPaymentGateway||(EthPaymentGateway={}));